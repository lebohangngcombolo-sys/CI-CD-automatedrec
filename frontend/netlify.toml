[build]
base = "frontend"
command = """
bash -lc '
set -e

# Ensure VERSION exists in repo root
if [ ! -f ../VERSION ]; then
  echo "ERROR: VERSION file not found in repo root"
  exit 1
fi

# Read SemVer from VERSION file
SEMVER=$(cat ../VERSION)

# Generate Calendar Version automatically: YYYY.MM.WW_DD_ENV
# Example: 2026.01.AC1_DEV
YEAR=$(date +%Y)
MONTH=$(date +%m)
DAY_NUMBER=$(date +%d)
ENVIRONMENT="DEV"  # Adjust automatically if needed (DEV/STAGING/PROD)

# Map week number and day number to letters
WEEK_LETTERS=(A B C D E F G H I J K L M N O P Q R S T U V W X Y Z)
DAY_LETTERS=(A B C D E F G)
WEEK_INDEX=$(( $(date +%V) - 1 ))
DAY_INDEX=$(( $(date +%u) - 1 ))
WEEK_LETTER=${WEEK_LETTERS[$WEEK_INDEX]}
DAY_LETTER=${DAY_LETTERS[$DAY_INDEX]}

CALVER="${YEAR}.${MONTH}.${WEEK_LETTER}${DAY_LETTER}${DAY_NUMBER}_${ENVIRONMENT}"

echo "Building frontend with versions:"
echo "  SemVer: $SEMVER"
echo "  CalVer: $CALVER"

# Install Flutter if not cached
if [ ! -d "$HOME/flutter" ]; then
  git clone https://github.com/flutter/flutter.git -b stable --depth 1 $HOME/flutter
fi
export PATH="$HOME/flutter/bin:$PATH"

# Configure Flutter
flutter config --no-analytics
flutter precache --web

# Build the web app with both version defines
flutter build web --release \
  --dart-define=APP_SEMVER=$SEMVER \
  --dart-define=APP_VERSION=$CALVER
'
"""
publish = "build/web"

[build.environment]
FLUTTER_WEB = "true"
NODE_VERSION = "18"

[[redirects]]
from = "/*"
to = "/index.html"
status = 200

[[headers]]
for = "/*"
[headers.values]
X-Frame-Options = "DENY"
X-Content-Type-Options = "nosniff"
Referrer-Policy = "strict-origin-when-cross-origin"
