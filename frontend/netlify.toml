[build]
base = "frontend"
command = """
bash -lc '
set -e

# Ensure VERSION exists
if [ ! -f VERSION ]; then
  echo "ERROR: VERSION file not found"
  exit 1
fi

APP_VERSION=$(cat VERSION)
echo "Building frontend with version: $APP_VERSION"

# Install Flutter if not cached
if [ ! -d "$HOME/flutter" ]; then
  git clone https://github.com/flutter/flutter.git -b stable --depth 1 $HOME/flutter
fi
export PATH="$HOME/flutter/bin:$PATH"

# Configure Flutter
flutter config --no-analytics
flutter precache --web

# Build the web app WITH version injection
flutter build web --release \
  --dart-define=APP_VERSION=$APP_VERSION
'
"""
publish = "build/web"

[build.environment]
FLUTTER_WEB = "true"
NODE_VERSION = "18"

[[redirects]]
from = "/*"
to = "/index.html"
status = 200

[[headers]]
for = "/*"
[headers.values]
X-Frame-Options = "DENY"
X-Content-Type-Options = "nosniff"
Referrer-Policy = "strict-origin-when-cross-origin"
