name: CI/CD Pipeline

on:
  push:
    branches:
      - develop
      - main
  pull_request:
    branches:
      - develop
      - main
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"
  FLUTTER_VERSION: "3.38.5"

# -------------------------
# CI: BACKEND VALIDATION
# -------------------------
jobs:
  backend-ci:
    name: Backend CI
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: recruitment_test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Backend Dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-flask pytest-mock

      - name: Backend Validation (Install Only)
        working-directory: backend
        env:
          PYTHONPATH: ${{ github.workspace }}/backend
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          echo "✓ Backend dependencies installed successfully"
          echo "⚠️ Backend tests are currently skipped"

# -------------------------
# CI: FRONTEND VALIDATION
# -------------------------
  frontend-ci:
    name: Frontend CI
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: Disable Flutter analytics
        run: flutter config --no-analytics

      - name: Verify Flutter and Dart versions
        run: |
          flutter --version
          dart --version

      - name: Install Frontend Dependencies
        run: |
          cd frontend
          flutter pub get

      - name: Build Frontend (Validation Only)
        run: |
          cd frontend
          flutter build web --release --no-wasm-dry-run

# -------------------------
# RELEASE: SEMANTIC VERSIONING & DEPLOY
# -------------------------
  release:
    name: Semantic Release & Deploy
    runs-on: ubuntu-latest
    needs:
      - backend-ci
      - frontend-ci

    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install release dependencies
        run: pip install requests

      - name: Run Semantic Release
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}

          RENDER_STAGING_DEPLOY_HOOK: ${{ secrets.RENDER_STAGING_DEPLOY_HOOK }}
          RENDER_PROD_DEPLOY_HOOK: ${{ secrets.RENDER_PROD_DEPLOY_HOOK }}

          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_STAGING_SITE_ID: ${{ secrets.NETLIFY_STAGING_SITE_ID }}
          NETLIFY_PROD_SITE_ID: ${{ secrets.NETLIFY_PROD_SITE_ID }}

        run: |
          python scripts/semantic_release.py


# -------------------------
# POST-DEPLOY: DATABASE MIGRATIONS
# -------------------------
  migrate:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs:
      - release

    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install backend dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Migrations
        run: |
          cd backend
          python -m flask db upgrade
        env:
          FLASK_APP: app:create_app
          FLASK_ENV: production
          DATABASE_URL: ${{ github.ref == 'refs/heads/main' && secrets.PROD_DATABASE_URL || secrets.STAGING_DATABASE_URL }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY || '' }}
