name: CI/CD Pipeline

on:
  push:
    branches:
      - develop
      - main
  pull_request:
    branches:
      - develop
      - main
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"
  # Updated to Flutter 3.38.5 as suggested by the error message
  FLUTTER_VERSION: "3.38.5"

# -------------------------
# CI: BACKEND VALIDATION
# -------------------------
jobs:
  backend-ci:
    name: Backend CI
    runs-on: ubuntu-latest
    
    # Add PostgreSQL and Redis services
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: recruitment_test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Read Version
        run: |
          VERSION=$(cat VERSION)
          SHORT_SHA=$(git rev-parse --short HEAD)
          if [[ "${GITHUB_REF}" == "refs/heads/develop" ]]; then
            echo "APP_VERSION=${VERSION}-dev+${SHORT_SHA}" >> $GITHUB_ENV
          else
            echo "APP_VERSION=${VERSION}" >> $GITHUB_ENV
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Backend Dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-flask pytest-mock

      - name: Backend Validation (Install Only)
        working-directory: backend
        env:
          PYTHONPATH: ${{ github.workspace }}/backend
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          echo "✓ Backend dependencies installed successfully"
          echo "⚠️ Backend tests are currently skipped"

# -------------------------
# CI: FRONTEND VALIDATION
# -------------------------
  frontend-ci:
    name: Frontend CI
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Read Version
      run: |
        VERSION=$(cat VERSION)
        SHORT_SHA=$(git rev-parse --short HEAD)
        if [[ "${GITHUB_REF}" == "refs/heads/develop" ]]; then
          echo "APP_VERSION=${VERSION}-dev+${SHORT_SHA}" >> $GITHUB_ENV
        else
          echo "APP_VERSION=${VERSION}" >> $GITHUB_ENV
        fi

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: stable

    - name: Disable Flutter analytics
      run: flutter config --no-analytics

    - name: Verify Flutter and Dart versions
      run: |
        echo "Flutter version:"
        flutter --version
        echo "Dart version:"
        dart --version

    - name: Install Frontend Dependencies
      run: |
        cd frontend
        flutter pub get

    - name: Build Frontend (Validation Only)
      run: cd frontend && flutter build web --release --no-wasm-dry-run




# -------------------------
# CD: STAGING DEPLOY
# -------------------------
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs:
      - backend-ci
      - frontend-ci
    if: github.ref == 'refs/heads/develop'

    steps:
      - uses: actions/checkout@v4

      - name: Read Version
        run: |
          VERSION=$(cat VERSION)
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "APP_VERSION=${VERSION}-dev+${SHORT_SHA}" >> $GITHUB_ENV

      # ---------- Backend ----------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install backend dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Staging Migrations
        run: |
          cd backend
          python -m flask db upgrade
        env:
          FLASK_APP: app:create_app
          FLASK_ENV: staging
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}

      - name: Deploy Backend to Render (Staging)
        run: curl -X POST "${{ secrets.RENDER_STAGING_DEPLOY_HOOK }}"


      # ---------- Frontend ----------
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Build Frontend (Staging)
        run: |
          cd frontend
          flutter build web --release \
            --dart-define=API_BASE_URL=https://api.staging.com \
            --dart-define=APP_VERSION=${APP_VERSION}

      - name: Deploy Frontend to Netlify (Staging)
        run: |
          npm install -g netlify-cli
          netlify deploy \
            --dir=frontend/build/web \
            --site=${{ secrets.NETLIFY_STAGING_SITE_ID }} \
            --auth=${{ secrets.NETLIFY_AUTH_TOKEN }} \
            --prod

# -------------------------
# CD: PRODUCTION DEPLOY
# -------------------------
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs:
      - backend-ci
      - frontend-ci
    if: github.ref == 'refs/heads/main'
    environment:
      name: production

    steps:
      - uses: actions/checkout@v4

      - name: Read Version
        run: |
          VERSION=$(cat VERSION)
          echo "APP_VERSION=${VERSION}" >> $GITHUB_ENV

      # ---------- Backend ----------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install backend dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Production Migrations
        run: |
          cd backend
          python -m flask db upgrade
        env:
          FLASK_APP: app:create_app
          FLASK_ENV: production
          DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}

      - name: Deploy Backend to Render (Production)
        run: curl -X POST "${{ secrets.RENDER_PROD_DEPLOY_HOOK }}"


      # ---------- Frontend ----------
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Build Frontend (Production)
        run: |
          cd frontend
          flutter build web --release \
            --dart-define=API_BASE_URL=https://api.production.com \
            --dart-define=APP_VERSION=${APP_VERSION}

      - name: Deploy Frontend to Netlify (Production)
        run: |
          npm install -g netlify-cli
          netlify deploy \
            --dir=frontend/build/web \
            --site=${{ secrets.NETLIFY_PROD_SITE_ID }} \
            --auth=${{ secrets.NETLIFY_AUTH_TOKEN }} \
            --prod