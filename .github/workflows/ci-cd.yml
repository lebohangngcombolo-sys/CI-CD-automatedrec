name: CI/CD Pipeline

on:
  push:
    branches:
      - develop
      - main
  pull_request:
    branches:
      - develop
      - main
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"
  FLUTTER_VERSION: "3.16.0"

# -------------------------
# CI: BACKEND VALIDATION
# -------------------------
jobs:
  backend-ci:
    name: Backend CI
    runs-on: ubuntu-latest
    
    # Add PostgreSQL and Redis services
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: recruitment_test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Read Version
        run: |
          VERSION=$(cat VERSION)
          SHORT_SHA=$(git rev-parse --short HEAD)
          if [[ "${GITHUB_REF}" == "refs/heads/develop" ]]; then
            echo "APP_VERSION=${VERSION}-dev+${SHORT_SHA}" >> $GITHUB_ENV
          else
            echo "APP_VERSION=${VERSION}" >> $GITHUB_ENV
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Backend Dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-flask pytest-mock

      - name: Run Backend Tests (Blocking)
        working-directory: backend
        env:
          PYTHONPATH: ${{ github.workspace }}/backend
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          FLASK_ENV: testing
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/recruitment_test_db
          REDIS_URL: redis://localhost:6379/0
          TESTING: 'true'
          SECRET_KEY: 'test-secret-key-for-ci'
          JWT_SECRET_KEY: 'test-jwt-secret-for-ci'
        run: |
          python -m pytest test/ -v --cov=app --cov-report=term-missing

# -------------------------
# CI: FRONTEND VALIDATION
# -------------------------
  frontend-ci:
    name: Frontend CI
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Read Version
        run: |
          VERSION=$(cat VERSION)
          SHORT_SHA=$(git rev-parse --short HEAD)
          if [[ "${GITHUB_REF}" == "refs/heads/develop" ]]; then
            echo "APP_VERSION=${VERSION}-dev+${SHORT_SHA}" >> $GITHUB_ENV
          else
            echo "APP_VERSION=${VERSION}" >> $GITHUB_ENV
          fi

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: Install Frontend Dependencies
        run: cd frontend && flutter pub get

      - name: Run Frontend Analyzer
        run: cd frontend && flutter analyze

      - name: Build Frontend (Validation Only)
        run: cd frontend && flutter build web --release

# -------------------------
# CD: STAGING DEPLOY
# -------------------------
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs:
      - backend-ci
      - frontend-ci
    if: github.ref == 'refs/heads/develop'

    steps:
      - uses: actions/checkout@v4

      - name: Read Version
        run: |
          VERSION=$(cat VERSION)
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "APP_VERSION=${VERSION}-dev+${SHORT_SHA}" >> $GITHUB_ENV

      # ---------- Backend ----------
      - name: Run Staging Migrations
        run: |
          cd backend
          flask db upgrade
        env:
          FLASK_APP: backend
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}

      - name: Deploy Backend to Render (Staging)
        run: curl -X POST "${{ secrets.RENDER_STAGING_DEPLOY_HOOK }}"

      # ---------- Frontend ----------
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Build Frontend (Staging)
        run: |
          cd frontend
          flutter build web --release \
            --dart-define=API_BASE_URL=https://api.staging.com \
            --dart-define=APP_VERSION=${APP_VERSION}

      - name: Deploy Frontend to Netlify (Staging)
        run: |
          npm install -g netlify-cli
          netlify deploy \
            --dir=frontend/build/web \
            --site=${{ secrets.NETLIFY_STAGING_SITE_ID }} \
            --auth=${{ secrets.NETLIFY_AUTH_TOKEN }} \
            --prod

# -------------------------
# CD: PRODUCTION DEPLOY
# -------------------------
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs:
      - backend-ci
      - frontend-ci
    if: github.ref == 'refs/heads/main'
    environment:
      name: production

    steps:
      - uses: actions/checkout@v4

      - name: Read Version
        run: |
          VERSION=$(cat VERSION)
          echo "APP_VERSION=${VERSION}" >> $GITHUB_ENV

      # ---------- Backend ----------
      - name: Run Production Migrations
        run: |
          cd backend
          flask db upgrade
        env:
          FLASK_APP: backend
          DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}

      - name: Deploy Backend to Render (Production)
        run: curl -X POST "${{ secrets.RENDER_PROD_DEPLOY_HOOK }}"

      # ---------- Frontend ----------
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Build Frontend (Production)
        run: |
          cd frontend
          flutter build web --release \
            --dart-define=API_BASE_URL=https://api.production.com \
            --dart-define=APP_VERSION=${APP_VERSION}

      - name: Deploy Frontend to Netlify (Production)
        run: |
          npm install -g netlify-cli
          netlify deploy \
            --dir=frontend/build/web \
            --site=${{ secrets.NETLIFY_PROD_SITE_ID }} \
            --auth=${{ secrets.NETLIFY_AUTH_TOKEN }} \
            --prod